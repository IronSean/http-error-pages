#!/usr/bin/env bash

# The array that store call parameters.
# shellcheck disable=SC2034
__init_params=()
__script_params=("$@")

# ``````````````````````````````````````````````````````````````````````````````
# Function name: GenHttpCodes()
#
# Description:
#   Generate http codes.
#
# Usage:
#   GenHttpCodes "json" "dir" "fa"
#
# Examples:
#   GenHttpCodes "src/4xx.json" "${_errors}/4xx" "fas fa-info-circle orange"
#

function GenHttpCodes() {

  local _jsonf="$1"
  local _fdir="$2"
  local _fa_img="$3"

  local _count=$(jq -r ".[].code" ${_jsonf} | wc -l)
  local _end=$((_count - 1))

  mkdir -p "$_fdir"

  for i in $(seq 0 $_end) ; do

    GetData "${i}" "code"
    _http_code="$_msg"

    cp "${_templates}/_template.html" "${_fdir}/${_http_code}.html"

    GetData "${i}" "title"
    _http_title="$_msg"

    sed -i "s/HTTP_CODE/${_http_code} ${_http_title}/g" "${_fdir}/${_http_code}.html"

    GetData "${i}" "desc"
    _http_desc="$_msg"

    sed -i "s/HTTP_DESCRIPTION/${_http_desc}/g" "${_fdir}/${_http_code}.html"
    sed -i "s/FA_IMG/${_fa_img}/g" "${_fdir}/${_http_code}.html"

    sed "s/^[ \t]*//" -i "${_fdir}/${_http_code}.html"

  done

  return "$_STATE"

}

# ``````````````````````````````````````````````````````````````````````````````
# Function name: GetData()
#
# Description:
#   Get data from json file.
#
# Usage:
#   GetData key value
#
# Examples:
#   GetData 1 "message"
#

function GetData() {

  local _FUNCTION_ID="GetData"
  local _STATE="0"

  _msg=""

  local _key="$1"
  local _value="$2"

  export _msg=$(jq -r ".[${_key}].${_value}" ${_jsonf})

  return "$_STATE"

}

function __main__() {

  local _FUNCTION_ID="__main__"
  local _STATE="0"

  local _param="${__script_params[0]}"

  local _templates="templates"
  local _sites="sites"
  local _errors="${_sites}/errors"
  local _maintenance="${_sites}/maintenance"
  local _invalid_domain="${_sites}/invalid-domain"
  local _rate_limit="${_sites}/rate-limit"
  local _http_code=""

  for i in "${_sites}" "${_errors}" "${_maintenance}" \
           "${_invalid_domain}" "${_rate_limit}" ; do

    mkdir -p "$i"

  done

  GenHttpCodes "src/4xx.json" "${_errors}/4xx" "fas fa-info-circle orange"
  GenHttpCodes "src/5xx.json" "${_errors}/5xx" "fas fa-exclamation-triangle red"

  cp "${_templates}/_maintenance.html" "${_maintenance}/maintenance.html" && \
  ln -s "${_templates}/_maintenance.html" "${_maintenance}/index.html"

  cp "${_templates}/_invalid-domain.html" "${_invalid_domain}/invalid-domain.html" && \
  ln -s "${_templates}/_maintenance.html" "${_invalid_domain}/index.html"

  cp "${_templates}/_rate-limit.html" "${_rate_limit}/rate-limit.html" && \
  ln -s "${_templates}/_maintenance.html" "${_rate_limit}/index.html"

}

# We pass arguments to the __main__ function.
# It is required if you want to run on arguments type $1, $2, ...
__main__ "${__script_params[@]}"
